class e{}class t{components={};addComponent(e,t){this.components[e]=t}removeComponent(e){delete this.components[e]}getComponent(e){return this.components[e]}}let s;var o;(o=s||(s={}))[o.Tick=0]="Tick",o[o.Keyboard=1]="Keyboard",o[o.KeyUp=2]="KeyUp",o[o.Click=3]="Click",o[o.RightClick=4]="RightClick";class i{requiredComponents=[];constructor(e,t,s){this.requiredComponents=e,this.trigger=t,this.update=s}}class n{systems=[];constructor(e){this.game=e}addSystem(e){this.systems.push(e)}updateSystems(e){const t=this.systems.filter((t=>t.trigger===e));for(const e of t)for(const t of this.game.ecs.entitiesWithComponents(this.game.currentRoom,e.requiredComponents))e.update(this.game,t)}}class r{entities=[];componentManagers=new Map;constructor(e){this.systemManager=new n(e)}createEntity(){let e=this.entities.length;for(;this.entities.includes(e);)e++;return this.entities.push(e),e}removeEntity(e){this.entities.splice(this.entities.indexOf(e),1);for(const t of this.componentManagers.values())t.components[e]&&t.removeComponent(e)}bringToFront(e){this.entities.splice(this.entities.indexOf(e),1),this.entities.push(e)}hasComponent(e,t){return void 0!==this.componentManagers.get(t)?.getComponent(e)}addComponent(e,s,o=[]){this.componentManagers.has(s)||this.componentManagers.set(s,new t),this.componentManagers.get(s).addComponent(e,new s(...o))}getComponent(e,t){return this.componentManagers.get(t).getComponent(e)}entitiesWithComponents(e,t){const s=[];for(const o of e.entities){let e=!0;for(const s of t)if(!this.hasComponent(o,s)){e=!1;break}e&&s.push(o)}return s}}class a{constructor(e,t){this.x=e,this.y=t}static equal(e,t){return e.x===t.x&&e.y===t.y}shifted(e){return new a(this.x+e.x,this.y+e.y)}scaled(e,t){return new a(this.x/e*t,this.y/e*t)}centred(e){return new a(this.x+e/2,this.y+e/2)}isInside(e){return this.x>=e.x&&this.x<=e.x+e.width&&this.y>=e.y&&this.y<=e.y+e.height}clone(){return new a(this.x,this.y)}}class l{constructor(e,t,s,o){this.x=e,this.y=t,this.width=s,this.height=o}overlaps(e){return this.x<e.x+e.width&&this.x+this.width>e.x&&this.y<e.y+e.height&&this.y+this.height>e.y}static fromVecs(e,t){return new l(e.x,e.y,t.x,t.y)}}const h=(e,t)=>Math.floor(Math.random()*(t-e+1))+e,c=(e,t,s=e.currentRoom)=>s.entities.some((s=>{if(s===t)return!1;if(e.ecs.hasComponent(s,y)){const o=e.ecs.getComponent(t,y).getActualHitbox(e.ecs.getComponent(t,d)),i=e.ecs.getComponent(s,y).getActualHitbox(e.ecs.getComponent(s,d));return o.overlaps(i)}return!1})),m=(e,t,s)=>{if(t.allEmpty()||s.x<e.tileSize/2||s.y<e.tileSize/2||s.x>(e.roomSize.x-1)*e.tileSize-e.tileSize/2||s.y>(e.roomSize.y-1)*e.tileSize-e.tileSize/2)return!1;const[o,i]=t.takeItem(),n=e.ecs.getComponent(o,d),r=n.pixels.clone();return n.pixels=s,e.ecs.hasComponent(o,y)&&c(e,o)?(n.pixels=r,t.addItem(o,i),!1):(n.room=n.room.clone(),e.ecs.bringToFront(o),e.ecs.bringToFront(e.player),!0)};class d{constructor(e,t){this.pixels=e,this.room=t}getCentre(e){return new a(this.pixels.x+e/2,this.pixels.y+e/2)}}class p{lastFrameChange=Date.now();constructor(e,t,s){this.image=e,this.frame=t,this.dest=s||new a(null,null)}}class g{constructor(e){this.velocity=e,this.speedX=0,this.speedY=0}speedsTo(e,t){const s=Math.hypot(e,t);return[e/s*this.velocity,t/s*this.velocity]}get currentVelocity(){return Math.hypot(this.speedX,this.speedY)}}class y extends l{constructor(e){super(e.x,e.y,e.width,e.height)}getActualHitbox(e){return new y(new l(this.x+e.pixels.x,this.y+e.pixels.y,this.width,this.height))}}class u{constructor(e,t){this.leftHand=e,this.rightHand=t}hasSpace(){return null===this.leftHand||null===this.rightHand}allEmpty(){return null===this.leftHand&&null===this.rightHand}addItem(e,t){return"left"===t&&null===this.leftHand?(this.leftHand=e,e):null===this.rightHand?(this.rightHand=e,e):null}takeItem(){if(null!==this.leftHand){const e=this.leftHand;return this.leftHand=null,[e,"left"]}if(null!==this.rightHand){const e=this.rightHand;return this.rightHand=null,[e,"right"]}return null}}class x{constructor(e){this.health=e,this.maxHealth=e}heal(e){this.health=Math.min(this.health+e,this.maxHealth)}damage(e){this.health=Math.max(this.health-e,0),this.health}}class f extends e{constructor(e){super(),this.damage=e}}class S{sneaking=!1}class w{}class C{}class z extends i{constructor(){super([S,g,d],s.Keyboard,((e,t)=>{const s=e.ecs.getComponent(t,g);if(e.keys.a||e.keys.arrowleft?e.keys.w||e.keys.arrowup?[s.speedX,s.speedY]=s.speedsTo(-1,-1):e.keys.s||e.keys.arrowdown?[s.speedX,s.speedY]=s.speedsTo(-1,1):[s.speedX,s.speedY]=s.speedsTo(-1,0):e.keys.d||e.keys.arrowright?e.keys.w||e.keys.arrowup?[s.speedX,s.speedY]=s.speedsTo(1,-1):e.keys.s||e.keys.arrowdown?[s.speedX,s.speedY]=s.speedsTo(1,1):[s.speedX,s.speedY]=s.speedsTo(1,0):e.keys.w||e.keys.arrowup?[s.speedX,s.speedY]=s.speedsTo(0,-1):e.keys.s||e.keys.arrowdown?[s.speedX,s.speedY]=s.speedsTo(0,1):(s.speedX=0,s.speedY=0),e.keys.shift){s.speedX/=2,s.speedY/=2;e.ecs.getComponent(t,S).sneaking=!0}}))}}let H;var k;(k=H||(H={}))[k.ShortGrass=0]="ShortGrass",k[k.TallGrass=1]="TallGrass",k[k.Flowers1=2]="Flowers1",k[k.Flowers2=3]="Flowers2";class M{tiles=[];constructor(e,t){this.game=e,this.pos=t;for(let e=0;e<this.game.roomSize.y;e++){this.tiles.push([]);for(let t=0;t<this.game.roomSize.x;t++)if(0==t||0==e||t==this.game.roomSize.x-1||e==this.game.roomSize.y-1)this.tiles[e].push(H.ShortGrass);else{const t=Math.random()<.8?H.ShortGrass:Math.random()<.7?H.TallGrass:Math.random()<.5?H.Flowers1:H.Flowers2;this.tiles[e].push(t)}}}render(){this.game.ctx.clearRect(0,0,this.game.canvas.width,this.game.canvas.height);for(let e=0;e<this.game.roomSize.y;e++)for(let t=0;t<this.game.roomSize.x;t++){const s=this.tiles[e][t],o=this.game.tileSize;this.game.ctx.drawImage(this.game.images.tiles,16*s,0,16,16,t*o,e*o,o,o)}}get entities(){return[this.game.leftHandItemBox,this.game.rightHandItemBox].concat(this.game.ecs.entities.filter((e=>!!this.game.ecs.hasComponent(e,d)&&a.equal(this.game.ecs.getComponent(e,d).room,this.pos))))}}const v=(e,t,s)=>{const o=h(e,t-e-s);return Array(s).fill(null).map(((e,t)=>o+t))},b=e=>{const t=[];for(let s=0;s<e.roomCount.y;s++)for(let o=0;o<e.roomCount.x;o++){const i=new a(o,s),n=new M(e,i);n.doors={top:v(5,e.roomSize.x,4),bottom:v(5,e.roomSize.x,4),left:v(3,e.roomSize.y,3),right:v(3,e.roomSize.y,3)},0===o&&(n.doors.left=[]),0===s&&(n.doors.top=[]),o===e.roomCount.x-1&&(n.doors.right=[]),s===e.roomCount.y-1&&(n.doors.bottom=[]);const r=e=>t.find((t=>a.equal(t.pos,e))),h=(e,t,s)=>{r(e)&&(t.doors[s]=r(e).doors[{top:"bottom",bottom:"top",left:"right",right:"left"}[s]])};h(i.shifted(new a(0,-1)),n,"top"),h(i.shifted(new a(0,1)),n,"bottom"),h(i.shifted(new a(-1,0)),n,"left"),h(i.shifted(new a(1,0)),n,"right"),t.push(n);for(let t=0;t<e.roomSize.y;t++)for(let s=0;s<e.roomSize.x;s++)if(0===s||0===t||s===e.roomSize.x-1||t===e.roomSize.y-1){const o=e.ecs.createEntity();let r;e.ecs.addComponent(o,d,[new a(s*e.tileSize,t*e.tileSize),i]);let h=[new a(0,0),new a(16,16)];0===s?0===t?r=[0,48]:t===e.roomSize.y-1?r=[32,48]:t===n.doors.left[0]-1?(r=[48,32],h=[new a(0,0),new a(14,14)]):t===n.doors.left[n.doors.left.length-1]+1?(r=[16,32],h=[new a(0,2),new a(14,14)]):n.doors.left.includes(t)?e.ecs.removeEntity(o):(r=[48,16],h=[new a(0,0),new a(14,16)]):s===e.roomSize.x-1?0===t?r=[16,48]:t===e.roomSize.y-1?r=[48,48]:t===n.doors.right[0]-1?(r=[32,32],h=[new a(2,0),new a(14,14)]):t===n.doors.right[n.doors.right.length-1]+1?(r=[0,32],h=[new a(2,2),new a(14,14)]):n.doors.right.includes(t)?e.ecs.removeEntity(o):(r=[16,16],h=[new a(2,0),new a(14,16)]):0===t?s===n.doors.top[0]-1?(r=[48,32],h=[new a(0,0),new a(14,14)]):s===n.doors.top[n.doors.top.length-1]+1?(r=[32,32],h=[new a(2,0),new a(14,14)]):n.doors.top.includes(s)?e.ecs.removeEntity(o):(r=[0,16],h=[new a(0,0),new a(16,14)]):t===e.roomSize.y-1&&(s===n.doors.bottom[0]-1?(r=[16,32],h=[new a(0,2),new a(14,14)]):s===n.doors.bottom[n.doors.bottom.length-1]+1?(r=[0,32],h=[new a(2,2),new a(14,14)]):n.doors.bottom.includes(s)?e.ecs.removeEntity(o):(r=[32,16],h=[new a(0,2),new a(16,14)])),e.ecs.addComponent(o,p,[e.images.tiles,new l(...r??[0,0],16,16)]),e.ecs.addComponent(o,y,[l.fromVecs(...h.map((t=>t.scaled(16,e.tileSize))))])}}return t};class I extends i{constructor(){super([d,p],s.Tick,((e,t)=>{const s=e.ecs.getComponent(t,d),o=e.ecs.getComponent(t,p);if(e.ctx.drawImage(o.image,o.frame.x,o.frame.y,o.frame.width,o.frame.height,s.pixels.x,s.pixels.y,o.dest.x??e.tileSize,o.dest.y??e.tileSize),e.keys.h&&e.ecs.hasComponent(t,y)){const o=e.ecs.getComponent(t,y).getActualHitbox(s);e.ctx.strokeStyle="#ff2222",e.ctx.lineWidth=Math.ceil(e.tileSize/90),e.ctx.strokeRect(o.x,o.y,o.width,o.height)}}))}}class P extends i{constructor(){super([w,g,p],s.Tick,((e,t)=>{const s=e.ecs.getComponent(t,g),o=e.ecs.getComponent(t,p),i=e.ecs.getComponent(t,d);if(0===s.speedX&&0===s.speedY?o.frame.y=0:s.speedX<0?o.frame.y=32:s.speedX>0?o.frame.y=48:s.speedY<0?o.frame.y=16:s.speedY>0&&(o.frame.y=0),i.pixels.x+=s.speedX,c(e,t)&&(i.pixels.x-=s.speedX),i.pixels.y+=s.speedY,c(e,t)&&(i.pixels.y-=s.speedY),0!==s.speedX||0!==s.speedY){const e=1/s.currentVelocity*350;Date.now()-o.lastFrameChange>=e&&(o.frame.x+=16,o.frame.x%=64,o.lastFrameChange=Date.now())}else o.frame.x=0;if(e.ecs.hasComponent(t,x)){const o=e.ecs.getComponent(t,x);o.damage(s.currentVelocity/150),0===s.currentVelocity&&o.heal(o.maxHealth/2e3)}i.pixels.x<-e.tileSize/2&&i.room.x>0?(i.room.x--,i.pixels.x=e.tileSize*e.roomSize.x-e.tileSize/2):i.pixels.x>e.tileSize*e.roomSize.x-e.tileSize/2&&i.room.x<e.roomSize.x-1?(i.room.x++,i.pixels.x=-e.tileSize/2):i.pixels.y<-e.tileSize/2&&i.room.y>0?(i.room.y--,i.pixels.y=e.tileSize*e.roomSize.y-e.tileSize/2):i.pixels.y>e.tileSize*e.roomSize.y-e.tileSize/2&&i.room.y<e.roomSize.y-1&&(i.room.y++,i.pixels.y=-e.tileSize/2)}))}}class T extends i{constructor(){super([u],s.Click,((e,t)=>{const s=e.ecs.getComponent(t,u),o=e.ecs.hasComponent(s.rightHand,f)?s.rightHand:e.ecs.hasComponent(s.leftHand,f)?s.leftHand:null;if(o){const s=e.ecs.getComponent(o,f);s.holder=t,s.frameCount=0,s.totalFrames=15;const i=e.ecs.getComponent(t,d).pixels.centred(e.tileSize);s.startAngle=Math.atan2(e.lastClickPos.y-i.y,e.lastClickPos.x-i.x),s.swingRadians=Math.PI/3,s.pivotPointOffset=new a(Math.cos(s.startAngle)*e.tileSize/5,Math.sin(s.startAngle)*e.tileSize/5)}const i=e.ecs.getComponent(t,d),n=e.currentRoom.entities.slice().reverse().find((s=>{if(!e.ecs.hasComponent(s,C)&&!e.ecs.hasComponent(s,x))return!1;if(s===t)return!1;const o=e.ecs.getComponent(s,d),n=Math.abs(i.pixels.x-o.pixels.x),r=Math.abs(i.pixels.y-o.pixels.y);if(Math.hypot(n,r)>1.8*e.tileSize)return!1;let a=!1;e.ecs.hasComponent(s,y)||(e.ecs.addComponent(s,y,[new l(0,0,e.tileSize,e.tileSize)]),a=!0);const h=e.ecs.getComponent(s,y),c=e.lastClickPos.isInside(h.getActualHitbox(o));return a&&e.ecs.componentManagers.get(y).removeComponent(s),c}));if(n&&s.hasSpace()){const t=s.addItem(n,"left"),o=e.ecs.getComponent(t,d);o.pixels=s.leftHand===t?e.leftHandItemPos:e.rightHandItemPos,o.room=e.room}}))}}class E extends i{constructor(){super([u,d],s.RightClick,((e,t)=>{const s=e.ecs.getComponent(t,d),o=e.lastClickPos.x-s.pixels.x,i=e.lastClickPos.y-s.pixels.y;if(Math.hypot(o,i)>5*e.tileSize)return;const n=e.ecs.getComponent(t,u);n.allEmpty()||m(e,n,e.lastClickPos.shifted(new a(-e.tileSize/2,-e.tileSize/2)))}))}}class X extends i{constructor(){super([S,u],s.KeyUp,((e,t)=>{if(e.keys.f){const s=e.ecs.getComponent(t,u);if(s.leftHand&&!s.rightHand){s.rightHand=s.leftHand,s.leftHand=null;e.ecs.getComponent(s.rightHand,d).pixels=e.rightHandItemPos}else if(!s.leftHand&&s.rightHand){s.leftHand=s.rightHand,s.rightHand=null;e.ecs.getComponent(s.leftHand,d).pixels=e.leftHandItemPos}else if(s.leftHand&&s.rightHand){const t=s.leftHand;s.leftHand=s.rightHand,s.rightHand=t;const o=e.ecs.getComponent(s.leftHand,d),i=e.ecs.getComponent(s.rightHand,d);o.pixels=e.leftHandItemPos,i.pixels=e.rightHandItemPos}}if(e.keys.q){const s=e.ecs.getComponent(t,u);if(!s.allEmpty()){const o=e.ecs.getComponent(t,d);for(const t of[0,1,-1])for(const i of[-1,1,0]){if(m(e,s,new a(o.pixels.x+e.tileSize*i,o.pixels.y+e.tileSize*t)))return}}}}))}}class Y extends i{constructor(){super([x,d],s.Tick,((e,t)=>{const s=e.ecs.getComponent(t,x),o=e.ecs.getComponent(t,d),i=(t,s)=>{e.ctx.fillStyle=t,e.ctx.fillRect(o.pixels.x,o.pixels.y+e.tileSize+4,e.tileSize*s,e.tileSize/8)};i("#ccc",1),i(`hsl(${s.health/s.maxHealth*100}, 100%, 50%)`,s.health/s.maxHealth)}))}}const F=(e,t,s,o,i)=>{const n=e.ecs.createEntity();let r;e.ecs.addComponent(n,y,[i??new l(0,0,e.tileSize,e.tileSize)]);do{r=new a((h(2,e.roomSize.x-3)+Math.random()-.5)*e.tileSize,(h(2,e.roomSize.y-3)+Math.random()-.5)*e.tileSize),e.ecs.addComponent(n,d,[r,t.pos])}while(c(e,n,t));return i||e.ecs.componentManagers.get(y).removeComponent(n),e.ecs.addComponent(n,p,[s,o]),e.ecs.addComponent(n,C),n},R=e=>{for(const t of e.rooms)for(let s=0;s<h(5,10);s++)F(e,t,e.images.items,new l(0,0,16,16),new l(1,1,e.tileSize-1,e.tileSize-1));const t=F(e,e.currentRoom,e.images.items,new l(0,16,16,16));e.ecs.addComponent(t,f,[5])};class A extends i{constructor(){super([f],s.Tick,((e,t)=>{const s=e.ecs.getComponent(t,f);if(s.frameCount<s.totalFrames){s.frameCount++;const o=e.ecs.getComponent(t,p),i=e.ecs.getComponent(s.holder,d).pixels.centred(e.tileSize);e.ctx.save(),e.ctx.translate(s.pivotPointOffset.x+i.x,s.pivotPointOffset.y+i.y),e.ctx.rotate(s.startAngle+s.swingRadians*s.frameCount/s.totalFrames),e.ctx.drawImage(o.image,o.frame.x,o.frame.y,o.frame.width,o.frame.height,0,.8*-e.tileSize,.8*e.tileSize,.8*e.tileSize),e.ctx.restore()}}))}}const q=new class{ecs=new r(this);images={};keys={};constructor(e,t){this.canvas=e,this.ctx=e.getContext("2d"),this.level=t,document.addEventListener("keydown",(e=>{this.keys[e.key.toLowerCase()]=!0,this.ecs.systemManager.updateSystems(s.Keyboard)})),document.addEventListener("keyup",(e=>{this.ecs.systemManager.updateSystems(s.KeyUp),delete this.keys[e.key.toLowerCase()],this.ecs.systemManager.updateSystems(s.Keyboard)})),document.addEventListener("click",(e=>{this.setLastClickPos(e),this.ecs.systemManager.updateSystems(s.Click)})),document.addEventListener("contextmenu",(e=>{e.preventDefault(),this.setLastClickPos(e),this.ecs.systemManager.updateSystems(s.RightClick)})),this.roomCount=new a(Math.ceil(t/2),Math.ceil(t/2)),t%2==0&&this.roomCount.x++,this.room=new a(Math.floor(this.roomCount.x/2),Math.floor(this.roomCount.y/2)),this.roomSize=new a(null,null),this.roomSize.y=Math.floor(9*(innerHeight/innerWidth+1)),this.tileSize=Math.floor(innerHeight/this.roomSize.y),this.roomSize.x=Math.floor(innerWidth/this.tileSize),this.canvas.width=this.roomSize.x*this.tileSize,this.canvas.height=this.roomSize.y*this.tileSize,this.ctx.imageSmoothingEnabled=!1;const o=["tiles","player","items","item-box"],i=[];for(const e of o)i.push(new Promise(((t,s)=>{const o=new Image;o.src="./img/"+e+".png",o.onload=()=>t(o),o.onerror=e=>s(e)})));Promise.all(i).then((e=>{e.forEach(((e,t)=>this.images[o[t]]=e)),[this.leftHandItemBox,this.leftHandItemPos]=this.addItemBox(new a(this.tileSize,(this.roomSize.y-4)*this.tileSize)),[this.rightHandItemBox,this.rightHandItemPos]=this.addItemBox(new a((this.roomSize.x-4)*this.tileSize,(this.roomSize.y-4)*this.tileSize)),this.player=this.ecs.createEntity(),this.ecs.addComponent(q.player,p,[this.images.player,new l(0,0,16,16)]),this.ecs.addComponent(q.player,d,[new a((this.roomSize.x/2-.5)*this.tileSize,(this.roomSize.y/2-.5)*this.tileSize),this.room]),this.ecs.addComponent(q.player,g,[this.tileSize/20]),this.ecs.addComponent(q.player,w),this.ecs.addComponent(q.player,S),this.ecs.addComponent(q.player,u,[null,null]),this.ecs.addComponent(q.player,x,[100]),this.ecs.addComponent(q.player,y,[l.fromVecs(new a(2,0).scaled(16,this.tileSize).shifted(new a(0,2)),new a(12,16).scaled(16,this.tileSize).shifted(new a(0,-2)))]),this.rooms=b(this),R(this),this.ecs.bringToFront(this.player),this.ecs.systemManager.addSystem(new z),this.ecs.systemManager.addSystem(new P),this.ecs.systemManager.addSystem(new T),this.ecs.systemManager.addSystem(new E),this.ecs.systemManager.addSystem(new X),this.ecs.systemManager.addSystem(new I),this.ecs.systemManager.addSystem(new Y),this.ecs.systemManager.addSystem(new A),this.tick()}))}setLastClickPos(e){const t=this.canvas.getBoundingClientRect();this.lastClickPos=new a(e.clientX-t.left,e.clientY-t.top)}addItemBox(e){const t=this.ecs.createEntity();return this.ecs.addComponent(t,p,[this.images["item-box"],new l(0,0,48,48),new a(3*this.tileSize,3*this.tileSize)]),this.ecs.addComponent(t,d,[e,this.room]),this.ecs.addComponent(t,y,[l.fromVecs(new a(11,11).scaled(16,this.tileSize),new a(26,26).scaled(16,this.tileSize))]),[t,e.shifted(new a(this.tileSize,this.tileSize))]}tick(){this.currentRoom.render(),this.ecs.systemManager.updateSystems(s.Tick),requestAnimationFrame((()=>this.tick()))}get currentRoom(){return this.rooms.find((e=>a.equal(e.pos,this.room)))}}(document.querySelector("canvas"),4);