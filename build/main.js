class e{constructor(e,t){this.x=e,this.y=t}static equal(e,t){return e.x===t.x&&e.y===t.y}shifted(t){return new e(this.x+t.x,this.y+t.y)}multiplied(t){return new e(this.x*t,this.y*t)}angleTo(e){return Math.atan2(e.y-this.y,e.x-this.x)}distTo(e){const t=e.x-this.x,s=e.y-this.y;return Math.hypot(t,s)}scaled(t,s){return new e(this.x/t*s,this.y/t*s)}centred(t){return new e(this.x+t/2,this.y+t/2)}isInside(e){return this.x>=e.x&&this.x<=e.x+e.width&&this.y>=e.y&&this.y<=e.y+e.height}clone(){return new e(this.x,this.y)}}class t{constructor(e,t,s,o){this.x=e,this.y=t,this.width=s,this.height=o}overlaps(e){return this.x<e.x+e.width&&this.x+this.width>e.x&&this.y<e.y+e.height&&this.y+this.height>e.y}static fromVecs(e,s){return new t(e.x,e.y,s.x,s.y)}}const s=(e,t)=>Math.floor(Math.random()*(t-e+1))+e,o=(e,s,o=e.roomAt(e.playerRoomPos))=>{const n=e.ecs.getComponent(s,f);if(e.ecs.hasComponent(s,w))return o.entities.some((t=>{if(t===s)return!1;if(e.ecs.hasComponent(t,w)){const o=e.ecs.getComponent(t,w).getActualHitbox(e.ecs.getComponent(t,f));return e.ecs.getComponent(s,w).getActualHitbox(n).overlaps(o)}return!1}));{const o=e.ecs.getComponent(e.leftHandItemBox,w).getActualHitbox(e.ecs.getComponent(e.leftHandItemBox,f)),i=e.ecs.getComponent(e.rightHandItemBox,w).getActualHitbox(e.ecs.getComponent(e.rightHandItemBox,f));e.ecs.addComponent(s,w,[new t(0,0,e.tileSize,e.tileSize)]);const a=e.ecs.getComponent(s,w).getActualHitbox(n);let r;return r=!(!o.overlaps(a)&&!i.overlaps(a)),e.ecs.removeComponent(s,w),r}},n=(e,t,s)=>{if(t.allEmpty()||s.x<e.tileSize/2||s.y<e.tileSize/2||s.x>(e.roomSize.x-1)*e.tileSize-e.tileSize/2||s.y>(e.roomSize.y-1)*e.tileSize-e.tileSize/2)return!1;const[n,a]=t.takeItem(),r=e.ecs.getComponent(n,f),l=r.pixels.clone();return r.pixels=s,o(e,n)?(r.pixels=l,t.addItem(n,a),!1):(r.room=r.room.clone(),e.ecs.bringToFront(n),e.ecs.entitiesWithComponents(e.roomAt(e.playerRoomPos),[M]).forEach(e.ecs.bringToFront,e.ecs),i(e.getAudio("place")).play(),!0)},i=e=>e.cloneNode(),a=(e,t)=>{const s=e.ecs.getComponent(t,f),n=e.ecs.getComponent(t,C),i=n.speedX*e.tileSize/e.currentFrameRate,a=n.speedY*e.tileSize/e.currentFrameRate;s.pixels.x+=i,(o(e,t)||t!==e.player&&(s.pixels.x<e.tileSize/2||s.pixels.x>e.canvas.width-1.5*e.tileSize))&&(s.pixels.x-=i),s.pixels.y+=a,(o(e,t)||t!==e.player&&(s.pixels.y<e.tileSize/2||s.pixels.y>e.canvas.height-1.5*e.tileSize))&&(s.pixels.y-=a)},r=(t,n,i)=>{let a;do{a=new e((s(2,t.roomSize.x-3)+Math.random()-.5)*t.tileSize,(s(2,t.roomSize.y-3)+Math.random()-.5)*t.tileSize),t.ecs.addComponent(i,f,[a,n.pos])}while(o(t,i,n))},l=(e,t)=>e.hasComponent(t,T);class c{}class h{components={};addComponent(e,t){this.components[e]=t}removeComponent(e){delete this.components[e]}getComponent(e){return this.components[e]}}let m;var p;(p=m||(m={}))[p.Tick=0]="Tick",p[p.Keyboard=1]="Keyboard",p[p.KeyUp=2]="KeyUp",p[p.Click=3]="Click",p[p.RightClick=4]="RightClick",p[p.Hit=5]="Hit";class d{requiredComponents=[];constructor(e,t,s){this.requiredComponents=e,this.trigger=t,this.update=s}}class g{systems=[];constructor(e){this.game=e}addSystem(e){this.systems.push(e)}updateSystems(e){const t=this.systems.filter((t=>t.trigger===e));for(const e of t)for(const t of this.game.ecs.entitiesWithComponents(this.game.roomAt(this.game.playerRoomPos),e.requiredComponents))e.update(this.game,t)}}class u{#e=[];componentManagers=new Map;constructor(e){this.systemManager=new g(e)}get entities(){return this.#e.filter((e=>!l(this,e)))}createEntity(){let e=this.#e.length;for(;this.#e.includes(e);)e++;return this.#e.push(e),e}removeEntity(e){this.#e.splice(this.#e.indexOf(e),1);for(const t of this.componentManagers.values())t.components[e]&&t.removeComponent(e)}bringToFront(e){this.#e.splice(this.#e.indexOf(e),1),this.#e.push(e)}hasComponent(e,t){return void 0!==this.componentManagers.get(t)?.getComponent(e)}addComponent(e,t,s=[]){this.componentManagers.has(t)||this.componentManagers.set(t,new h),this.componentManagers.get(t).addComponent(e,new t(...s))}getComponent(e,t){return this.componentManagers.get(t).getComponent(e)}removeComponent(e,t){this.componentManagers.get(t).removeComponent(e)}entitiesWithComponents(e,t){const s=[];for(const o of e.entities){let e=!0;for(const s of t)if(!this.hasComponent(o,s)){e=!1;break}e&&s.push(o)}return s}}class y{constructor(e,t,s,o,n){this.pos=e,this.angle=t,this.speed=s,this.friction=o,this.color=n}static createBurst(e,t,s,o,n,i,a){for(let r=0;r<t;r++)setTimeout((()=>{e.particles.push(new y(o,Math.random()*Math.PI*2,n*(.75+.5*Math.random()),i,a))}),s*r)}}class f{constructor(e,t){this.pixels=e,this.room=t}getCentre(t){return new e(this.pixels.x+t/2,this.pixels.y+t/2)}}class x{timeOflastFrameChange=0;constructor(t,s,o){this.image=t,this.frame=s,this.dest=o||new e(null,null)}}class C{constructor(e){this.velocity=e,this.speedX=0,this.speedY=0}speedsTo(e,t){const s=Math.hypot(e,t);return[e/s*this.velocity,t/s*this.velocity]}get currentVelocity(){return Math.hypot(this.speedX,this.speedY)}}class w extends t{constructor(e){super(e.x,e.y,e.width,e.height)}getActualHitbox(e){return new w(new t(this.x+e.pixels.x,this.y+e.pixels.y,this.width,this.height))}}class S{constructor(e,t){this.leftHand=e,this.rightHand=t}hasSpace(){return null===this.leftHand||null===this.rightHand}allEmpty(){return null===this.leftHand&&null===this.rightHand}addItem(e,t){return"left"===t&&null===this.leftHand?(this.leftHand=e,e):null===this.rightHand?(this.rightHand=e,e):null}takeItem(){if(null!==this.leftHand){const e=this.leftHand;return this.leftHand=null,[e,"left"]}if(null!==this.rightHand){const e=this.rightHand;return this.rightHand=null,[e,"right"]}return null}}class z{#t;#s;constructor(e,t,s){this.health=e,this.maxHealth=e,this.#t=t,this.#s=s}heal(e){this.health=Math.min(this.health+e,this.maxHealth)}damage(e){if(this.health=Math.max(this.health-e,0),0===this.health)if(this.#s===this.#t.player);else if(this.#t.ecs.hasComponent(this.#s,A)&&y.createBurst(this.#t,17,17,this.#t.ecs.getComponent(this.#s,f).getCentre(this.#t.tileSize),.08,.997,this.#t.ecs.getComponent(this.#s,A).color),this.#t.ecs.hasComponent(this.#s,P)){this.#t.ecs.addComponent(this.#s,T);const e=this.#t.ecs.getComponent(this.#s,P);e.timeOfDeath=performance.now(),e.timeUntilRespawn=s(...e.timeUntilRespawnRange),this.#t.toRespawn.push(this.#s)}else this.#t.ecs.removeEntity(this.#s)}}class H extends c{constructor(e){super(),this.damage=e}}class k{sneaking=!1}class M{constructor(e){this.canGetTired=e}}class I{}class v{randomWalkAngle=Math.random()*Math.PI*2;timeOflastAngleChange=0;constructor(e,t){this.target=e,this.maxTiles=t}}class A{constructor(e){this.color=e}}class T{constructor(e){this.shouldUpdate=e}}class P{constructor(e){this.timeUntilRespawnRange=e}}class b{timeOfLastHit=0;timeUntilNextHit=0;constructor(e,t){this.target=e,this.timeBetweenHitsRange=t}}class R extends d{constructor(){super([k,C],m.Keyboard,((e,t)=>{const s=e.ecs.getComponent(t,C);if(e.keys.a||e.keys.arrowleft?e.keys.w||e.keys.arrowup?[s.speedX,s.speedY]=s.speedsTo(-1,-1):e.keys.s||e.keys.arrowdown?[s.speedX,s.speedY]=s.speedsTo(-1,1):[s.speedX,s.speedY]=s.speedsTo(-1,0):e.keys.d||e.keys.arrowright?e.keys.w||e.keys.arrowup?[s.speedX,s.speedY]=s.speedsTo(1,-1):e.keys.s||e.keys.arrowdown?[s.speedX,s.speedY]=s.speedsTo(1,1):[s.speedX,s.speedY]=s.speedsTo(1,0):e.keys.w||e.keys.arrowup?[s.speedX,s.speedY]=s.speedsTo(0,-1):e.keys.s||e.keys.arrowdown?[s.speedX,s.speedY]=s.speedsTo(0,1):(s.speedX=0,s.speedY=0),e.keys.shift){s.speedX/=3,s.speedY/=3;e.ecs.getComponent(t,k).sneaking=!0}}))}}class E extends d{constructor(){super([M,C,x],m.Tick,((e,t)=>{const s=e.ecs.getComponent(t,C),o=e.ecs.getComponent(t,x),n=e.ecs.getComponent(t,f);if(0===s.speedX&&0===s.speedY)o.frame.y=0;else{const e=Math.atan2(s.speedY,s.speedX);o.frame.y=0,e>-5*Math.PI/8&&e<-3*Math.PI/8?o.frame.y=16:e>=-3*Math.PI/8&&e<=3*Math.PI/8?o.frame.y=48:(e<=-5*Math.PI/8||e>=5*Math.PI/8)&&(o.frame.y=32)}if(a(e,t),0!==s.speedX||0!==s.speedY){const t=1/s.currentVelocity*400;if(performance.now()-o.timeOflastFrameChange>=t&&(o.frame.x+=16,o.frame.x%=64,o.timeOflastFrameChange=performance.now(),16===o.frame.x||48===o.frame.x)){const t=i(e.getAudio("footstep"));t.volume*=.7,t.volume*=s.currentVelocity/s.velocity,t.play()}}else o.frame.x=0;const r=e.ecs.getComponent(t,M);if(e.ecs.hasComponent(t,z)&&r.canGetTired){const o=e.ecs.getComponent(t,z);0!==s.currentVelocity?o.damage(s.currentVelocity/120):o.heal(o.maxHealth/3e3)}t===e.player&&(n.pixels.x<-e.tileSize/2&&n.room.x>0?(n.room.x--,n.pixels.x=e.tileSize*e.roomSize.x-e.tileSize/2):n.pixels.x>e.tileSize*e.roomSize.x-e.tileSize/2&&n.room.x<e.roomSize.x-1?(n.room.x++,n.pixels.x=-e.tileSize/2):n.pixels.y<-e.tileSize/2&&n.room.y>0?(n.room.y--,n.pixels.y=e.tileSize*e.roomSize.y-e.tileSize/2):n.pixels.y>e.tileSize*e.roomSize.y-e.tileSize/2&&n.room.y<e.roomSize.y-1&&(n.room.y++,n.pixels.y=-e.tileSize/2))}))}}class F extends d{constructor(){super([f,x],m.Tick,((e,t)=>{const s=e.ecs.getComponent(t,f),o=e.ecs.getComponent(t,x);if(e.ctx.drawImage(o.image,o.frame.x,o.frame.y,o.frame.width,o.frame.height,s.pixels.x,s.pixels.y,o.dest.x??e.tileSize,o.dest.y??e.tileSize),e.keys.h&&e.ecs.hasComponent(t,w)){const o=e.ecs.getComponent(t,w).getActualHitbox(s);e.ctx.strokeStyle="#ff2222",e.ctx.lineWidth=Math.ceil(e.tileSize/90),e.ctx.strokeRect(o.x,o.y,o.width,o.height)}}))}}class O extends d{constructor(){super([S,f,k],m.RightClick,((t,s)=>{const o=t.ecs.getComponent(s,f),i=t.lastClickPos.x-o.pixels.x,a=t.lastClickPos.y-o.pixels.y;if(Math.hypot(i,a)>5*t.tileSize)return;const r=t.ecs.getComponent(s,S);n(t,r,t.lastClickPos.shifted(new e(-t.tileSize/2,-t.tileSize/2)))}))}}class X extends d{constructor(){super([k,S,f],m.KeyUp,((t,s)=>{if("f"===t.keyReleased){const e=t.ecs.getComponent(s,S);if(e.leftHand&&!e.rightHand){e.rightHand=e.leftHand,e.leftHand=null;t.ecs.getComponent(e.rightHand,f).pixels=t.rightHandItemPos}else if(!e.leftHand&&e.rightHand){e.leftHand=e.rightHand,e.rightHand=null;t.ecs.getComponent(e.leftHand,f).pixels=t.leftHandItemPos}else if(e.leftHand&&e.rightHand){const s=e.leftHand;e.leftHand=e.rightHand,e.rightHand=s;const o=t.ecs.getComponent(e.leftHand,f),n=t.ecs.getComponent(e.rightHand,f);o.pixels=t.leftHandItemPos,n.pixels=t.rightHandItemPos}(e.leftHand||e.rightHand)&&i(t.getAudio("swap_hands")).play()}if("q"===t.keyReleased){const o=t.ecs.getComponent(s,S),i=t.ecs.getComponent(s,f),a={left:new e(-1,0),right:new e(1,0),above:new e(0,-1),below:new e(0,1)}[t.keys.d?"left":t.keys.a?"right":t.keys.w?"below":t.keys.s?"above":null],r=()=>{for(const s of[0,1,-1])for(const a of[-1,1,0]){if(n(t,o,new e(i.pixels.x+t.tileSize*a,i.pixels.y+t.tileSize*s)))return}};if(a){n(t,o,i.pixels.shifted(a.multiplied(t.tileSize)))||r()}else r()}if("shift"===t.keyReleased){t.ecs.getComponent(s,k).sneaking=!1}}))}}class Y extends d{constructor(){super([z,f],m.Tick,((e,t)=>{const s=e.ecs.getComponent(t,z),o=e.ecs.getComponent(t,f),n=(t,s)=>{e.ctx.fillStyle=t,e.ctx.fillRect(o.pixels.x,o.pixels.y+e.tileSize+4,e.tileSize*s,e.tileSize/8)};n("#ccc",1),n(`hsl(${s.health/s.maxHealth*100}, 100%, 50%)`,s.health/s.maxHealth)}))}}class L extends d{constructor(){super([H],m.Tick,((e,t)=>{const s=e.ecs.getComponent(t,H);if(s.frameCount<s.totalFrames){s.frameCount++;const o=e.ecs.getComponent(t,x),n=e.ecs.getComponent(s.holder,f).pixels.centred(e.tileSize);e.ctx.save(),e.ctx.translate(s.pivotPointOffset.x+n.x,s.pivotPointOffset.y+n.y),e.ctx.rotate(s.startAngle+s.swingRadians*s.frameCount/s.totalFrames),e.ctx.drawImage(o.image,o.frame.x,o.frame.y,o.frame.width,o.frame.height,0,.8*-e.tileSize,.8*e.tileSize,.8*e.tileSize),e.ctx.restore()}}))}}class B extends d{constructor(){super([v,f],m.Tick,((e,t)=>{const s=e.ecs.getComponent(t,v),o=e.ecs.getComponent(t,f),n=e.ecs.getComponent(s.target,f),i=n.pixels.distTo(o.pixels);let a=s.maxTiles*e.tileSize;if(s.target===e.player){e.ecs.getComponent(e.player,k).sneaking&&(a/=2)}const r=e.ecs.getComponent(t,C);if(i<a){const e=n.pixels.x-o.pixels.x,t=n.pixels.y-o.pixels.y;[r.speedX,r.speedY]=r.speedsTo(e,t)}else r.speedX=Math.cos(s.randomWalkAngle)*r.velocity,r.speedY=Math.sin(s.randomWalkAngle)*r.velocity,performance.now()-s.timeOflastAngleChange>3e3&&Math.random()<.1&&(s.randomWalkAngle+=Math.PI/4+Math.random()*Math.PI/4*(Math.random()<.5?1:-1),s.randomWalkAngle%=2*Math.PI,s.timeOflastAngleChange=performance.now());e.keys.h&&(e.ctx.beginPath(),e.ctx.moveTo(o.pixels.x+e.tileSize/2,o.pixels.y+e.tileSize/2),i<a?e.ctx.lineTo(n.pixels.x+e.tileSize/2,n.pixels.y+e.tileSize/2):e.ctx.lineTo(o.pixels.x+Math.cos(s.randomWalkAngle)*e.canvas.width,o.pixels.y+Math.sin(s.randomWalkAngle)*e.canvas.width),e.ctx.fillStyle="red",e.ctx.stroke())}))}}const W=(t,s,o)=>{const n=t.ecs.getComponent(s,S),a=t.ecs.hasComponent(n.rightHand,H)?n.rightHand:t.ecs.hasComponent(n.leftHand,H)?n.leftHand:null;if(a){const n=t.ecs.getComponent(a,H);n.holder=s,n.frameCount=0,n.totalFrames=15;const i=t.ecs.getComponent(s,f),r=t.ecs.getComponent(o,f);n.startAngle=i.pixels.angleTo(r?.pixels||t.lastClickPos),n.swingRadians=Math.PI/3,n.pivotPointOffset=new e(Math.cos(n.startAngle)*t.tileSize/5,Math.sin(n.startAngle)*t.tileSize/5)}if(null!==o)if(t.ecs.hasComponent(o,I))if(n.hasSpace()){const a=n.addItem(o,"left"),r=t.ecs.getComponent(a,f);s===t.player?r.pixels=n.leftHand===a?t.leftHandItemPos:t.rightHandItemPos:r.pixels=new e(0,0),r.room=t.ecs.getComponent(s,f).room,i(t.getAudio("pick_up")).play()}else i(t.getAudio("decline")).play();else if(a&&t.ecs.hasComponent(o,z)){const e=t.ecs.getComponent(o,z),s=t.ecs.getComponent(a,H).damage;e.damage(s)}};class U extends d{constructor(){super([k,f,S],m.Click,((e,s)=>{const o=e.ecs.getComponent(s,f),n=e.roomAt(e.playerRoomPos).entities.slice().reverse().find((n=>{if(!e.ecs.hasComponent(n,I)&&!e.ecs.hasComponent(n,z))return!1;if(n===s)return!1;const i=e.ecs.getComponent(n,f);if(o.pixels.distTo(i.pixels)>e.tileSize*e.minHitDist)return!1;let a=!1;e.ecs.hasComponent(n,w)||(e.ecs.addComponent(n,w,[new t(0,0,e.tileSize,e.tileSize)]),a=!0);const r=e.ecs.getComponent(n,w),l=e.lastClickPos.isInside(r.getActualHitbox(i));return a&&e.ecs.removeComponent(n,w),l}));W(e,s,n??null)}))}}class q extends d{constructor(){super([],m.Tick,(t=>{for(const[s,o]of t.particles.entries())o.pos=o.pos.shifted(new e(o.speed*Math.cos(o.angle),o.speed*Math.sin(o.angle))),o.speed*=o.friction,o.speed<.004&&t.particles.splice(s,1),t.ctx.fillStyle=o.color,t.ctx.fillRect(o.pos.x,o.pos.y,5,5)}))}}let V;var G;(G=V||(V={}))[G.Image=0]="Image",G[G.Audio=1]="Audio";class K{#o=[];constructor(e){this.#o=e}static loadAsset(e){return new Promise(((t,s)=>{if(e.type===V.Image){const o=new Image;o.src=e.path,o.onload=()=>t(o),o.onerror=s}else if(e.type===V.Audio){const o=new Audio;o.src=e.path,o.oncanplaythrough=()=>t(o),o.onerror=s}}))}async loadAll(){const e=this.#o.map(K.loadAsset),t=await Promise.all(e);return{images:t.filter((e=>e instanceof HTMLImageElement)),audio:t.filter((e=>e instanceof HTMLAudioElement))}}}const D=(e,t,s,o,n)=>{const i=e.ecs.createEntity();return n&&e.ecs.addComponent(i,w,[n]),r(e,t,i),e.ecs.addComponent(i,x,[s,o]),e.ecs.addComponent(i,I),i},_=(s,o)=>{const n=s.ecs.createEntity();s.ecs.addComponent(n,x,[s.getImage("zombie"),new t(0,0,16,16)]),s.ecs.addComponent(n,w,[t.fromVecs(new e(2,0).scaled(16,s.tileSize).shifted(new e(0,2)),new e(12,16).scaled(16,s.tileSize).shifted(new e(0,-2)))]),r(s,o,n),s.ecs.addComponent(n,C,[1]),s.ecs.addComponent(n,v,[s.player,10]),s.ecs.addComponent(n,z,[50,s,n]),s.ecs.addComponent(n,b,[s.player,[1e3,2e3]]),s.ecs.addComponent(n,P,[[5e3,1e4]]);const i=s.ecs.createEntity();s.ecs.addComponent(i,x,[s.getImage("items"),new t(0,16,16,16)]),s.ecs.addComponent(i,f,[new e(s.canvas.width,s.canvas.height),o.pos]),s.ecs.addComponent(i,I),s.ecs.addComponent(i,H,[5]),s.ecs.addComponent(n,S,[i,null]),s.ecs.addComponent(n,M,[!1]),s.ecs.addComponent(n,A,["#bb0000"])},N=e=>{for(const o of e.rooms){for(let n=0;n<s(5,10);n++)D(e,o,e.getImage("items"),new t(0,0,16,16),new t(1,1,e.tileSize-1,e.tileSize-1));for(let t=0;t<Math.round(e.level/3);t++)_(e,o)}const o=D(e,e.roomAt(e.playerRoomPos),e.getImage("items"),new t(0,16,16,16));e.ecs.addComponent(o,H,[5])},$=(s,o)=>{const n=s.ecs.createEntity();return s.ecs.addComponent(n,f,[o,new e(Math.floor(s.roomCount.x/2),Math.floor(s.roomCount.y/2))]),s.ecs.addComponent(n,x,[s.getImage("player"),new t(0,0,16,16)]),s.ecs.addComponent(n,C,[2]),s.ecs.addComponent(n,M,[!0]),s.ecs.addComponent(n,k),s.ecs.addComponent(n,S,[null,null]),s.ecs.addComponent(n,z,[100,s,n]),s.ecs.addComponent(n,w,[t.fromVecs(new e(2,0).scaled(16,s.tileSize).shifted(new e(0,2)),new e(12,16).scaled(16,s.tileSize).shifted(new e(0,-2)))]),n};let j;var J;(J=j||(j={}))[J.ShortGrass=0]="ShortGrass",J[J.TallGrass=1]="TallGrass",J[J.Flowers1=2]="Flowers1",J[J.Flowers2=3]="Flowers2";class Q{tiles=[];constructor(e,t){this.game=e,this.pos=t;for(let e=0;e<this.game.roomSize.y;e++){this.tiles.push([]);for(let t=0;t<this.game.roomSize.x;t++)if(0==t||0==e||t==this.game.roomSize.x-1||e==this.game.roomSize.y-1)this.tiles[e].push(j.ShortGrass);else{const t=Math.random()<.8?j.ShortGrass:Math.random()<.7?j.TallGrass:Math.random()<.5?j.Flowers1:j.Flowers2;this.tiles[e].push(t)}}}render(){this.game.ctx.clearRect(0,0,this.game.canvas.width,this.game.canvas.height);for(let e=0;e<this.game.roomSize.y;e++)for(let t=0;t<this.game.roomSize.x;t++){const s=this.tiles[e][t],o=this.game.tileSize;this.game.ctx.drawImage(this.game.getImage("tiles"),16*s,0,16,16,t*o,e*o,o,o)}}get entities(){return[this.game.leftHandItemBox,this.game.rightHandItemBox].concat(this.game.ecs.entities.filter((t=>!!this.game.ecs.hasComponent(t,f)&&e.equal(this.game.ecs.getComponent(t,f).room,this.pos))))}}const Z=(e,t,o)=>{const n=s(e,t-e-o);return Array(o).fill(null).map(((e,t)=>n+t))},ee=s=>{const o=[];for(let n=0;n<s.roomCount.y;n++)for(let i=0;i<s.roomCount.x;i++){const a=new e(i,n),r=new Q(s,a);r.doors={top:Z(5,s.roomSize.x,4),bottom:Z(5,s.roomSize.x,4),left:Z(3,s.roomSize.y,3),right:Z(3,s.roomSize.y,3)},0===i&&(r.doors.left=[]),0===n&&(r.doors.top=[]),i===s.roomCount.x-1&&(r.doors.right=[]),n===s.roomCount.y-1&&(r.doors.bottom=[]);const l=t=>o.find((s=>e.equal(s.pos,t))),c=(e,t,s)=>{l(e)&&(t.doors[s]=l(e).doors[{top:"bottom",bottom:"top",left:"right",right:"left"}[s]])};c(a.shifted(new e(0,-1)),r,"top"),c(a.shifted(new e(0,1)),r,"bottom"),c(a.shifted(new e(-1,0)),r,"left"),c(a.shifted(new e(1,0)),r,"right"),o.push(r);for(let o=0;o<s.roomSize.y;o++)for(let n=0;n<s.roomSize.x;n++)if(0===n||0===o||n===s.roomSize.x-1||o===s.roomSize.y-1){const i=s.ecs.createEntity();let l;s.ecs.addComponent(i,f,[new e(n*s.tileSize,o*s.tileSize),a]);let c=[new e(0,0),new e(16,16)];0===n?0===o?l=[0,48]:o===s.roomSize.y-1?l=[32,48]:o===r.doors.left[0]-1?(l=[48,32],c=[new e(0,0),new e(14,14)]):o===r.doors.left[r.doors.left.length-1]+1?(l=[16,32],c=[new e(0,2),new e(14,14)]):r.doors.left.includes(o)?s.ecs.removeEntity(i):(l=[48,16],c=[new e(0,0),new e(14,16)]):n===s.roomSize.x-1?0===o?l=[16,48]:o===s.roomSize.y-1?l=[48,48]:o===r.doors.right[0]-1?(l=[32,32],c=[new e(2,0),new e(14,14)]):o===r.doors.right[r.doors.right.length-1]+1?(l=[0,32],c=[new e(2,2),new e(14,14)]):r.doors.right.includes(o)?s.ecs.removeEntity(i):(l=[16,16],c=[new e(2,0),new e(14,16)]):0===o?n===r.doors.top[0]-1?(l=[48,32],c=[new e(0,0),new e(14,14)]):n===r.doors.top[r.doors.top.length-1]+1?(l=[32,32],c=[new e(2,0),new e(14,14)]):r.doors.top.includes(n)?s.ecs.removeEntity(i):(l=[0,16],c=[new e(0,0),new e(16,14)]):o===s.roomSize.y-1&&(n===r.doors.bottom[0]-1?(l=[16,32],c=[new e(0,2),new e(14,14)]):n===r.doors.bottom[r.doors.bottom.length-1]+1?(l=[0,32],c=[new e(2,2),new e(14,14)]):r.doors.bottom.includes(n)?s.ecs.removeEntity(i):(l=[32,16],c=[new e(0,2),new e(16,14)])),s.ecs.addComponent(i,x,[s.getImage("tiles"),new t(...l??[0,0],16,16)]),s.ecs.addComponent(i,w,[t.fromVecs(...c.map((e=>e.scaled(16,s.tileSize))))])}}return o};class te extends d{constructor(){super([],m.Tick,(e=>{for(const t of e.toRespawn){const s=e.ecs.getComponent(t,P);if(performance.now()-s.timeOfDeath>s.timeUntilRespawn){e.ecs.removeComponent(t,T);const s=e.ecs.getComponent(t,z);s.heal(s.maxHealth);const n=e.ecs.getComponent(t,f);o(e,t)&&r(e,e.roomAt(n.room),t),e.ecs.bringToFront(t),e.toRespawn.splice(e.toRespawn.indexOf(t),1)}}}))}}class se extends d{constructor(){super([b,f],m.Tick,((e,t)=>{const o=e.ecs.getComponent(t,b);if(null===o.target)return;const n=e.ecs.getComponent(t,f),i=e.ecs.getComponent(o.target,f);n.pixels.distTo(i.pixels)<e.tileSize*e.minHitDist&&performance.now()-o.timeOfLastHit>o.timeUntilNextHit&&(o.timeOfLastHit=performance.now(),o.timeUntilNextHit=s(...o.timeBetweenHitsRange),W(e,t,o.target))}))}}class oe{ecs=new u(this);toRespawn=[];particles=[];minHitDist=1.7;timeOfLastFrame=0;keys={};constructor(t,s,o){this.canvas=t,this.ctx=t.getContext("2d"),this.level=s,this.assets=o,document.addEventListener("keydown",(e=>{this.keys[e.key.toLowerCase()]=!0,this.ecs.systemManager.updateSystems(m.Keyboard)})),document.addEventListener("keyup",(e=>{const t=e.key.toLowerCase();this.keyReleased=t,this.ecs.systemManager.updateSystems(m.KeyUp),delete this.keys[t],this.ecs.systemManager.updateSystems(m.Keyboard)})),document.addEventListener("click",(e=>{this.setLastClickPos(e),this.ecs.systemManager.updateSystems(m.Click);const t=this.getAudio("music");t.loop=!0,t.volume=.5,t.play()})),document.addEventListener("contextmenu",(e=>{e.preventDefault(),this.setLastClickPos(e),this.ecs.systemManager.updateSystems(m.RightClick)})),this.roomCount=new e(Math.ceil(s/2),Math.ceil(s/2)),s%2==0&&this.roomCount.x++,this.roomSize=new e(null,null),this.roomSize.y=Math.floor(9*(innerHeight/innerWidth+1)),this.tileSize=Math.floor(innerHeight/this.roomSize.y),this.roomSize.x=Math.floor(innerWidth/this.tileSize),this.canvas.width=this.roomSize.x*this.tileSize,this.canvas.height=this.roomSize.y*this.tileSize,this.ctx.imageSmoothingEnabled=!1,this.player=$(this,new e((this.roomSize.x/2-.5)*this.tileSize,(this.roomSize.y/2-.5)*this.tileSize)),[this.leftHandItemBox,this.leftHandItemPos]=this.addItemBox(new e(this.tileSize,(this.roomSize.y-4)*this.tileSize)),[this.rightHandItemBox,this.rightHandItemPos]=this.addItemBox(new e((this.roomSize.x-4)*this.tileSize,(this.roomSize.y-4)*this.tileSize)),this.rooms=ee(this),N(this);for(const e of this.rooms)this.ecs.entitiesWithComponents(e,[M]).forEach(this.ecs.bringToFront,this.ecs);[R,B,E,U,X,O,te,se,F,Y,L,q].forEach((e=>this.ecs.systemManager.addSystem(new e)))}setLastClickPos(t){const s=this.canvas.getBoundingClientRect();this.lastClickPos=new e(t.clientX-s.left,t.clientY-s.top)}addItemBox(s){const o=this.ecs.createEntity();return this.ecs.addComponent(o,x,[this.getImage("item_box"),new t(0,0,48,48),new e(3*this.tileSize,3*this.tileSize)]),this.ecs.addComponent(o,f,[s,this.playerRoomPos]),this.ecs.addComponent(o,w,[t.fromVecs(new e(11,11).scaled(16,this.tileSize),new e(26,26).scaled(16,this.tileSize))]),[o,s.shifted(new e(this.tileSize,this.tileSize))]}tick(e){this.currentFrameRate=1e3/(e-this.timeOfLastFrame),this.timeOfLastFrame=e,document.hasFocus()&&(this.roomAt(this.playerRoomPos).render(),this.ecs.systemManager.updateSystems(m.Tick)),requestAnimationFrame((e=>this.tick(e)))}get playerRoomPos(){return this.ecs.getComponent(this.player,f).room}roomAt(t){return this.rooms.find((s=>e.equal(s.pos,t)))}getAsset(e){const t=[];for(const e in this.assets)t.push(...this.assets[e]);return t.find((t=>new RegExp(`${e}\\.[^\\.]+`).test(t.src)))}getImage(e){return this.getAsset(e)}getAudio(e){return this.getAsset(e)}}const ne=new K([{type:V.Image,path:"assets/images/tiles.png"},{type:V.Image,path:"assets/images/player.png"},{type:V.Image,path:"assets/images/items.png"},{type:V.Image,path:"assets/images/item_box.png"},{type:V.Image,path:"assets/images/zombie.png"},{type:V.Audio,path:"assets/sounds/music.mp3"},{type:V.Audio,path:"assets/sounds/footstep.mp3"},{type:V.Audio,path:"assets/sounds/pick_up.mp3"},{type:V.Audio,path:"assets/sounds/place.mp3"},{type:V.Audio,path:"assets/sounds/swap_hands.mp3"},{type:V.Audio,path:"assets/sounds/decline.mp3"}]);(async()=>{const e=await ne.loadAll();new oe(document.querySelector("canvas"),2,e).tick(0)})();